
# ガルフォース カオスの攻防 スムーススクロールパッチ メモ

以下、確認されていない情報や古い情報があります。

## 大まかな方針

BANK8 に SOUND DRIVER 割り込み関係領域(B97C-BC97) を 移動

BANK0 の 空いた領域にパッチコードの本体を配置

一部コード(BD90-BE6A)も BANK 0 の 元 SOUND DRIVER 領域に移動する

空いた領域にバンク共通パッチコードを置く(割り込みフック関係コードなど)



当初はGRAPHIC3(SCREEN4)を利用していたが512バイトのスプライトカラーテーブルの更新の負荷が高すぎたため元と同じくGRAPHIC2(SCREEN2)を利用。

当初はH.TIMIハンドラーは元のままとしあらたに追加するH.KEYIハンドラーでは走査線割り込みを処理する予定であったが走査線割り込みが間に合わないためH.TIMIハンドラーはBIOSに任せH.KEYIハンドラーでのみ割り込みを処理することとする。

## SOUND DRIVER 割り込み関係領域

### 元の用途

```
B97C-BC97 (796bytes) SOUND DRIVER割り込み関係

B8CD SOUND DRIVER RESET WORK ENTRY
B8EC SOUND DRIVER WAIT ENTRY (UNUSED?)
B8F3 SOUND DRIVER START ENTRY (A register:SONG NUMBER)
B97C SOUND DRIVER INTERRUPT ENTRY
BBD6 SOUND DRIVER NOTE TABLE START
BC56 SOUND DRIVER NOTE TABLE END
BC98 SOUND DRIVER END
```

### パッチ後の用途

```
BANK0 パッチコード 画面初期化関係領域から移動したコード
BANK8 SOUND DRIVER割り込みコード
```

## 画面初期化関係領域

### 元の用途

```
BD90-BE6A (219bytes) 画面初期化関係

BD90 画面初期化サブルーチン(タイトル画面表示時に毎回呼び出される)
BE05 パターン初期化ルーチン(バンク6)
BE0F パターン初期化ルーチン(バンク7)
BE4C H.TIMIフック設定ルーチン
```

### パッチ後の用途


```
BANK0/8 バンク共通パッチコード(割り込み関係など)
```

## ワークエリア

```

マジックキー関係

(C401).b ステージセレクト(0:標準ステージ1 1-5:ステージ-1)
(C402).b 開始時残機(3:標準)
(C403).b 開始時パワーアップ(0:標準 13:MAX)
(C404).b 0:標準 0以外:武器単体威力強化
(C405).b 0:標準 0以外:バリア 敵弾でパワーが落ちない
(C406).b 開始時仲間(0:標準,7FH全員)
(C407).b 0:標準 0以外:TRIGGER2 POWER UP(裏マジックキー機能)
(C408).b 0:標準 0Ch:マジックキー有効 03h:裏マジックキー有効 タイトルで[SELECT]

ゲーム開始時に初期化されないワーク

(C440).b ページ1バンク退避
(C441).b[0003h?] ハイスコア(BCD)
(C444).b ステージ退避(コンティニュー用) コンティニュー:下を押しながらトリガ2
(C445).b 仲間救出フラグ退避(コンティニュー用)

(C446-D1D9) 揮発ワーク(初期値0)

(C446).b 機体選択?(0-6)
(C447).b 仲間救出状態 各bit1で仲間救出
(C448).b[0003h?] スコア(BCD)
(C44D).b 01:タイトル画面 00:ゲーム中
(C44E).w 機体選択制限時間?
(C450).b 残機
(C451).b 00:通常 01:ミス
(C452),b[0020h] スコア仮想VRAM
(C472).b ??
(C473).b ??
(C474).b ??
(C475).b ??
(C476).w 進行カウンタ 0の場合のみネームテーブルを切り替える 通常はカウントダウン
(C478).b ネームテーブル切り替えフラグ
(C479).w 更新VRAMアドレス
(C47B).b 背景転送カウンタ(0の場合停止)
(C47C).b ボス戦中フラグ
(C47D).b ENDING進行度

(C47E).w ??
(C480).b メガROMバンク ステージデーターバンク
(C481).b ??
(C482).b/w ??
(C484).w ??

(C486).b[0008h] C47Eからの8bytesのコピー ステージ進行関係退避?

(C48E).b ?? ステージ
(C48F).w ??
(C491).w ??
(C493).b ??
(C494).w ??

(C496).b 00:通常 01:高速スクロール演出
(C497).b[0020h] 仮想ラインバッファ
(C4B7).b[0020h] ??
(C4D7).b[02e0h] 仮想ネームテーブル

(C7B7).b[0020h?] ??

(C7D7).w
(C7D9).b
(C7DA).w 仮想VRAMポインタ
(C7DC).b
(C7DD).b[0020h] ?? C4B7のコピー
(C7FD).b[?] ?? 

(CCDC).b 01:キャラ選択中フラグ
(CCDD).w ??
(CCEC).b キャラ別パワーアップコード?
(CCEE).b パワーアップ

(CD17).b 00:通常 01:パワーアップアイテム接触?
(CD37).w ???


(D035).b 00:通常 00以外:ダメージ
(D036).b 00:通常 00以外:ダメージ後無敵期間カウンタ?

(D0CE).b スティック状態 (0:中立 1:上 3:右 5:下 7:左)
(D0CF).b 前回のスティック状態
(D0D0).b TRIG1
(D0D1).b TRIG2
(D0D2).b TRIG1 RELEASE
(D0D3).b TRIG2 RELEASE
(D0D4).b [STOP]KEY STATE for pause
(D0D5).b ??
(D0D6).b ??
(D0D7).b 割り込み再入防止用 00:通常 01:割り込み処理中
(D0D8).b 割り込み待機用 00:割り込み未発生 01:割り込み発生
(D0D9).b 仮想スプライトアトリビュートテーブル切り替えフラグ
(D0DA).b[0080h] 仮想スプライトアトリビュートテーブル1
(D15A).b[0080h] 仮想スプライトアトリビュートテーブル2
(D1DA)～空き?

```

## その他作業中メモ


```
83A4 スコア更新


8899 ネームテーブルを横一ライン更新

88E5 ネームテーブル切り替え

BD25 RAM -> VRAM 転送 BC:サイズ

BDA9 CALL INIGRP GRAPHIC2モードに変更

```


```

BCEBのスプライトアトリビュートテーブル更新ルーチンをMODE2 用に置き換える
512byteのスプライトカラーテーブルの書き込みの負荷が高すぎるのでMODE2 への移行は取りやめ
スプライトドライバがローテーションを行っているため常時書き換えが発生する



D0D9 デュアルバッファ状態 #00:バッファ2更新 #01:バッファ1更新
D0DA バッファ1 32*4=128bytes
D15A バッファ2 32*4=128bytes

MSX1版(パッチ前)
0000-17FF VRAM パターン・ジェネレータ・テーブル
1800-1AFF VRAM パターン・ネーム・テーブル1
1B00-1B7F VRAM スプライト・アトリビュート・テーブル1
1B80-1BFF VRAM スプライト・アトリビュート・テーブル2
1C00-1EFF VRAM パターン・ネーム・テーブル2
1F00-1FFF VRAM 未使用
2000-37FF VRAM カラー・テーブル
3800-3FFF VRAM スプライト・パターン・ジェネレータ・テーブル


MSX2版 MODE2
1B00-1BFF VRAM パターン・ネーム・テーブル1スクロール用予備領域
1F00-1FFF VRAM パターン・ネーム・テーブル2スクロール用予備領域
4C00-4DFF VRAM スプライト・カラー・テーブル1
4E00-4E7F VRAM スプライト・アトリビュート・テーブル1
5C00-5DFF VRAM スプライト・カラー・テーブル2
5E00-5E7F VRAM スプライト・アトリビュート・テーブル2

MSX2版 MODE1
1B00-1B7F VRAM パターン・ネーム・テーブル1スクロール用予備領域
1B80-1BFF VRAM スプライト・アトリビュート・テーブル2
1F00-1F7F VRAM パターン・ネーム・テーブル2スクロール用予備領域
1F80-1FFF VRAM スプライト・アトリビュート・テーブル1
4E00-4FFF VRAM スプライト・アトリビュート・テーブル1
5E00-5FFF VRAM スプライト・アトリビュート・テーブル2




B97C-BC97 (796bytes) SOUND DRIVER 割り込みルーチン

BANK8に移動



BD90-BE04 (117bytes) 画面初期化サブルーチン(タイトル画面表示時に毎回呼び出される)

BE05-BE6A (102bytes) 領域が足りなくなったので移動

リロケータブルなので別のアドレスに移す

```

